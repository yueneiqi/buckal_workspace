name: Generate fd BUCK and push to fd-test

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    name: build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            os: ubuntu-latest
          - name: macos
            os: macos-latest
          - name: windows
            os: windows-latest

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Setup Rust toolchain (for Buck2 install)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly-2025-08-01

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install Buck2
        shell: bash
        run: |
          set -euo pipefail
          cargo +nightly-2025-08-01 install --git https://github.com/facebook/buck2.git --rev c6bfcc629378a00921aa04597551442c9e2ea2eb buck2
          buck2 --version

      - name: Ensure fd submodule has base branch
        shell: bash
        run: |
          set -euo pipefail
          cd test/3rd/fd
          git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"
          if git show-ref --verify --quiet refs/heads/base; then
            git checkout base
          else
            git checkout -b base origin/base
          fi

      - name: Generate + build + test (inplace)
        shell: bash
        run: |
          set -euo pipefail
          uv run test/buckal_fd_build.py --keep-rust-test --inplace --multi-platform --test --no-push

      - name: Prepare artifact (strip git metadata)
        shell: bash
        run: |
          set -euo pipefail
          rm -f test/3rd/fd/.git test/3rd/fd/.gitmodules || true

      - name: Upload generated fd tree
        uses: actions/upload-artifact@v4
        with:
          name: fd-tree-${{ matrix.name }}
          path: test/3rd/fd
          if-no-files-found: error

  push:
    name: push (linux runner)
    runs-on: ubuntu-latest
    needs: [ build ]
    steps:
      - name: Download linux artifact
        uses: actions/download-artifact@v4
        with:
          name: fd-tree-linux
          path: out/linux

      - name: Download macos artifact
        uses: actions/download-artifact@v4
        with:
          name: fd-tree-macos
          path: out/macos

      - name: Download windows artifact
        uses: actions/download-artifact@v4
        with:
          name: fd-tree-windows
          path: out/windows

      - name: Push linux-gen
        uses: cpina/github-action-push-to-another-repository@v1.7.3
        env:
          SSH_DEPLOY_KEY: ${{ secrets.FD_TEST_SSH_KEY }}
        with:
          source-directory: out/linux
          destination-github-username: yueneiqi
          destination-repository-name: fd-test
          user-email: 41898282+github-actions[bot]@users.noreply.github.com
          user-name: github-actions[bot]
          target-branch: linux-gen
          commit-message: Update generated fd (linux) from ORIGIN_COMMIT
          create-target-branch-if-needed: true

      - name: Push macos-gen
        uses: cpina/github-action-push-to-another-repository@v1.7.3
        env:
          SSH_DEPLOY_KEY: ${{ secrets.FD_TEST_SSH_KEY }}
        with:
          source-directory: out/macos
          destination-github-username: yueneiqi
          destination-repository-name: fd-test
          user-email: 41898282+github-actions[bot]@users.noreply.github.com
          user-name: github-actions[bot]
          target-branch: macos-gen
          commit-message: Update generated fd (macos) from ORIGIN_COMMIT
          create-target-branch-if-needed: true

      - name: Push windows-gen
        uses: cpina/github-action-push-to-another-repository@v1.7.3
        env:
          SSH_DEPLOY_KEY: ${{ secrets.FD_TEST_SSH_KEY }}
        with:
          source-directory: out/windows
          destination-github-username: yueneiqi
          destination-repository-name: fd-test
          user-email: 41898282+github-actions[bot]@users.noreply.github.com
          user-name: github-actions[bot]
          target-branch: windows-gen
          commit-message: Update generated fd (windows) from ORIGIN_COMMIT
          create-target-branch-if-needed: true
