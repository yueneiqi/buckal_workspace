name: Generate fd BUCK and push to fd-test

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    name: build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            os: ubuntu-latest
          - name: macos
            os: macos-latest
          - name: windows
            os: windows-latest

    steps:
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.longpaths true
          # Keep LF endings so the uploaded artifact doesn't break bash scripts on Linux.
          git config --global core.autocrlf input
          git config --global core.eol lf
          New-ItemProperty `
            -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem" `
            -Name "LongPathsEnabled" `
            -Value 1 `
            -PropertyType DWORD `
            -Force `
            | Out-Null

      - name: Checkout (with submodules)
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install Windows toolchain deps
        if: runner.os == 'Windows'
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain

      - name: Add MinGW to PATH
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          "${{ steps.msys2.outputs.msys2-location }}\\mingw64\\bin" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8

      - name: Install required Rust toolchains/targets
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install nightly-2025-08-01 -c rust-src -c llvm-tools-preview
          case "${RUNNER_OS}" in
            macOS)
              rustup target add --toolchain stable aarch64-apple-darwin
              ;;
            Windows)
              rustup toolchain install stable-x86_64-pc-windows-gnu
              rustup target add --toolchain stable x86_64-pc-windows-gnu
              ;;
          esac

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install Buck2
        shell: bash
        run: |
          set -euo pipefail
          cargo +nightly-2025-08-01 install --git https://github.com/facebook/buck2.git --rev c6bfcc629378a00921aa04597551442c9e2ea2eb buck2
          buck2 --version

      - name: Ensure fd submodule has base branch
        shell: bash
        run: |
          set -euo pipefail
          cd test/3rd/fd
          git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"
          if git show-ref --verify --quiet refs/heads/base; then
            git checkout base
          else
            git checkout -b base origin/base
          fi

      - name: Generate + build + test (inplace)
        shell: bash
        run: |
          set -euo pipefail
          uv run test/buckal_fd_build.py --test
          uv run test/buckal_fd_build.py --inplace --no-push --skip-build

      - name: Upload generated fd tree
        uses: actions/upload-artifact@v6
        with:
          name: fd-tree-${{ matrix.name }}
          path: test/3rd/fd
          if-no-files-found: error
          include-hidden-files: true

  push:
    name: push (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: [ build ]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            target_branch: linux-gen
          - name: macos
            target_branch: macos-gen
          - name: windows
            target_branch: windows-gen
    env:
      FD_TEST_DEST_USER: yueneiqi
      FD_TEST_DEST_REPO: fd-test
      FD_TEST_USER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      FD_TEST_USER_NAME: github-actions[bot]
    steps:
      - name: Download ${{ matrix.name }} artifact
        uses: actions/download-artifact@v4
        with:
          name: fd-tree-${{ matrix.name }}
          path: out

      - name: Configure git + SSH
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.email "${FD_TEST_USER_EMAIL}"
          git config --global user.name "${FD_TEST_USER_NAME}"

          mkdir -p "${HOME}/.ssh"
          install -m 0600 /dev/null "${HOME}/.ssh/deploy_key"
          printf '%s\n' "${{ secrets.FD_TEST_SSH_KEY }}" > "${HOME}/.ssh/deploy_key"
          ssh-keyscan -H github.com >> "${HOME}/.ssh/known_hosts"
          printf '%s\n' "Host github.com" >> "${HOME}/.ssh/config"
          printf '%s\n' "  IdentityFile ${HOME}/.ssh/deploy_key" >> "${HOME}/.ssh/config"
          printf '%s\n' "  IdentitiesOnly yes" >> "${HOME}/.ssh/config"

      - name: Force-push ${{ matrix.target_branch }}
        shell: bash
        run: |
          set -euo pipefail

          remote="git@github.com:${FD_TEST_DEST_USER}/${FD_TEST_DEST_REPO}.git"
          workdir="$(mktemp -d)"
          origin_commit="https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"

          if git clone --single-branch --depth 1 --branch "${{ matrix.target_branch }}" "${remote}" "${workdir}"; then
            :
          else
            git clone --single-branch --depth 1 "${remote}" "${workdir}"
            git -C "${workdir}" checkout -b "${{ matrix.target_branch }}"
          fi

          rsync -a --delete --exclude '.git' out/ "${workdir}/"

          # Artifacts produced on Windows can carry CRLF endings; normalize bash scripts to LF so
          # Linux CI jobs don't fail with "$'\\r': command not found".
          find "${workdir}" -type f -name '*.sh' -print0 | xargs -0 -r perl -pi -e 's/\r$//'

          git -C "${workdir}" add -A
          if ! git -C "${workdir}" diff --cached --quiet; then
            git -C "${workdir}" commit -m "Update generated fd (${{ matrix.name }}) from ${origin_commit}"
          fi

          git -C "${workdir}" push --force origin "HEAD:${{ matrix.target_branch }}"
