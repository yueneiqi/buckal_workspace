name: Generate fd BUCK and push to fd-test

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build:
    name: build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            os: ubuntu-latest
          - name: macos
            os: macos-latest
          - name: windows
            os: windows-latest

    steps:
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          git config --global core.longpaths true
          New-ItemProperty `
            -Path "HKLM:\\SYSTEM\\CurrentControlSet\\Control\\FileSystem" `
            -Name "LongPathsEnabled" `
            -Value 1 `
            -PropertyType DWORD `
            -Force `
            | Out-Null

      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"
          enable-cache: true

      - name: Setup Rust toolchain (stable)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Install required Rust toolchains/targets
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install nightly-2025-08-01 -c rust-src -c llvm-tools-preview
          case "${RUNNER_OS}" in
            Linux)
              rustup target add --toolchain stable aarch64-unknown-linux-gnu i686-unknown-linux-gnu
              ;;
            macOS)
              rustup target add --toolchain stable aarch64-apple-darwin
              ;;
            Windows)
              rustup toolchain install stable-x86_64-pc-windows-gnu
              rustup target add --toolchain stable i686-pc-windows-msvc aarch64-pc-windows-msvc x86_64-pc-windows-gnu
              ;;
          esac

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-all-crates: true

      - name: Install Buck2
        shell: bash
        run: |
          set -euo pipefail
          cargo +nightly-2025-08-01 install --git https://github.com/facebook/buck2.git --rev c6bfcc629378a00921aa04597551442c9e2ea2eb buck2
          buck2 --version

      - name: Ensure fd submodule has base branch
        shell: bash
        run: |
          set -euo pipefail
          cd test/3rd/fd
          git fetch --prune origin "+refs/heads/*:refs/remotes/origin/*"
          if git show-ref --verify --quiet refs/heads/base; then
            git checkout base
          else
            git checkout -b base origin/base
          fi

      - name: Generate + build + test (inplace)
        shell: bash
        run: |
          set -euo pipefail
          uv run test/buckal_fd_build.py --keep-rust-test --inplace --multi-platform --test --no-push

      - name: Prepare artifact (strip git metadata)
        shell: bash
        run: |
          set -euo pipefail
          rm -f test/3rd/fd/.git test/3rd/fd/.gitmodules || true

      - name: Upload generated fd tree
        uses: actions/upload-artifact@v4
        with:
          name: fd-tree-${{ matrix.name }}
          path: test/3rd/fd
          if-no-files-found: error

  push:
    name: push (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: [ build ]
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux
            target_branch: linux-gen
          - name: macos
            target_branch: macos-gen
          - name: windows
            target_branch: windows-gen
    env:
      FD_TEST_DEST_USER: yueneiqi
      FD_TEST_DEST_REPO: fd-test
      FD_TEST_USER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      FD_TEST_USER_NAME: github-actions[bot]
    steps:
      - name: Download ${{ matrix.name }} artifact
        uses: actions/download-artifact@v4
        with:
          name: fd-tree-${{ matrix.name }}
          path: out

      - name: Push ${{ matrix.target_branch }}
        uses: cpina/github-action-push-to-another-repository@v1.7.3
        env:
          SSH_DEPLOY_KEY: ${{ secrets.FD_TEST_SSH_KEY }}
        with:
          source-directory: out
          destination-github-username: ${{ env.FD_TEST_DEST_USER }}
          destination-repository-name: ${{ env.FD_TEST_DEST_REPO }}
          user-email: ${{ env.FD_TEST_USER_EMAIL }}
          user-name: ${{ env.FD_TEST_USER_NAME }}
          target-branch: ${{ matrix.target_branch }}
          commit-message: Update generated fd (${{ matrix.name }}) from ORIGIN_COMMIT
          create-target-branch-if-needed: true
