# Readable Summary
Fix bugs for add-multi-platform-support

<plan>
# Session Handoff Plan

## 1. Primary Request and Intent
- Implement multi-platform support (`add-multi-platform-support`) and fix regressions introduced by this feature. Recent user focus: bug fixes, especially rust_test/buildscript issues emerging after the platform changes.

## 2. Key Technical Concepts
- Buck/Buck2 rule generation for Rust (rust_library, rust_binary, rust_test).
- Platform handling: mapping Rust target triples to Buck `prelude//os:{linux,macos,windows}`; conditional deps via `os_deps`/`os_named_deps`; `compatible_with` on rules.
- cargo_platform cfg evaluation and platform-specific dependency emission.
- Buildscript environment (need NUM_JOBS to avoid panic in tikv-jemalloc-sys).
- Buckal wrapper select() expansion for os-specific deps.

## 3. Files and Code Sections
### cargo-buckal/src/platform.rs
- **Why important**: Core platform model. Introduced Tier1 (incl. x86_64-apple-darwin), cached cfgs, mapping to Os enum and Buck labels.
- **Changes**: Added Os enum, SUPPORTED_TARGETS list, cfg cache, oses_from_platform; package whitelist now returns BTreeSet<Os>.

### cargo-buckal/src/buck.rs
- **Why important**: Rule structs and trait extended for os-specific deps.
- **Changes**: Added `os_deps` and `os_named_deps` fields to rust_* rules; RustRule trait updated; CargoTargetKind now Clone+Copy; patch_from handles os_* fields.

### cargo-buckal/src/buckify.rs
- **Why important**: Emits Buck rules; now populates platform compatibility and os-specific deps.
- **Changes**: set_deps computes platform-conditioned deps into os_deps/os_named_deps using oses_from_platform; lookup_platforms -> compatible_with; loads rust_test from wrapper; buildscript env selection updated (but buildscript NUM_JOBS still an issue). Cache version bumped in cache.rs (see below).

### cargo-buckal/src/cache.rs
- **Why important**: Cache invalidation; version bumped to 2 to regenerate with platform model changes.

### buckal-bundles/wrapper.bzl
- **Why important**: Consumes os_deps/os_named_deps and exposes rust_test.
- **Changes**: rust_binary/library/test merge os_deps/os_named_deps via select with prelude os labels; load rust_test; removed get_reindeer_platforms dependency; simple select map.

### commits
- `cargo-buckal` commit: "Implement multi-platform os_deps support" (changes above).
- `buckal-bundles` commit: "Handle os_deps in rust rule wrapper".
- Root commit: "Update submodules for multi-platform support".

## 4. Problem Solving
- Implemented multi-platform support plumbing (platform model, os_deps, wrapper select) and compiled successfully (`cargo check` passes).
- `test/buckal_fd_build.py --test --keep-rust-test` works fine 

## 5. Pending Tasks
- investigate multi-platform failed build log that generated by test workflow, log dir: log/2025-12-11_22-05
</plan>
